---
date: 2024-02-02
title: Reproducible data science with Nix, part 9 -- rix is looking for testers!
tags: [R, Nix]
menu:
main:
  parent: Blog
  identifier: /blog/nix_for_r_part9.Rmd
  weight: 1
---

<div style="text-align:center;">
 <img src="/img/kick_rix.png">
</div>

After 5 months of work, [Philipp Baumann](https://github.com/philipp-baumann)
and myself are happy to announce that our package, `{rix}` is getting quite
close to being in a state we consider "done" (well, at least, for a first
release). We plan on submit it first to
[rOpenSci](https://ropensci.org/software-review/) for review, and later to CRAN.
But in the meantime, if you could test the package, we'd be grateful! We are
especially interested to see if you find the documentation clear, and if you are
able to run the features that require an installation of Nix, the `nix_build()`
and `with_nix()` functions. And I would truly recommend you read this blog post
to the end, because I guarantee you'll have your mind blown! If that's not the
case, send an insult my way on social media.

## What is rix?

`{rix}` is an R package that leverages Nix, a powerful package manager focusing
on reproducible builds. With Nix, it is possible to create project-specific
environments that contain a project-specific version of R and R packages (as
well as other tools or languages, if needed). You can use `{rix}` and Nix to
replace renv and Docker with one single tool. Nix is an incredibly useful piece
of software for ensuring reproducibility of projects, in research or otherwise,
or for running web applications like Shiny apps or plumber APIs in a controlled
environment. The advantage of using Nix over Docker is that the environments
that you define using Nix are not isolated from the rest of your machine: you
can still access files and other tools installed on your computer.

For example, here is how you could use `{rix}` to generate a file called
`default.nix`, which can then be used by Nix to actually build that environment
for you:

```{r}
library(rix)

path_default_nix <- tempdir()

rix(r_ver = "latest",
    r_pkgs = c("dplyr", "ggplot2"),
    system_pkgs = NULL,
    git_pkgs = NULL,
    ide = "code",
    shell_hook = NULL,
    project_path = path_default_nix,
    overwrite = TRUE,
    print = TRUE)
```

You don't need to have Nix installed to use `{rix}` and generate this
expression! This is especially useful if you want to generate an expression that
should then be used in a CI/CD environment for example.

But if you do have Nix installed, then you can use two great functions that
Philipp implemented, which we are really excited to tell you about!

## nix_build() and with_nix()

When you have a `default.nix` file that was generated by `rix::rix()`, and if
you have Nix installed on your system, you can build the corresponding
environment using the command line tool `nix-build`. But you can also build that
environment straight from an R session, by using
[`rix::nix_build()`](https://b-rodrigues.github.io/rix/reference/nix_build.html)!

But the reason
[`nix_build()`](https://b-rodrigues.github.io/rix/reference/nix_build.html) is
really useful, is because it gets called by
[`with_nix()`](https://b-rodrigues.github.io/rix/reference/with_nix.html).
[`with_nix()`](https://b-rodrigues.github.io/rix/reference/with_nix.html) is a
very interesting function, because it allows you to evaluate a single function
within a so-called subshell. That subshell can have a whole other version of R
and R packages than your main session, and you can use it to execute an
arbitrary function (or a whole, complex expression), and then get the result
back into your main session. You could use older versions of packages to get a
result that might not be possible to get in a current version. Consider the
following example: on a recent version of `{stringr}`,
`stringr::str_subset(c("", "a"), "")` results in an error, but older versions
would return `"a"`. Returning an error is actually what this should do, but hey,
if you have code that relies on that old behaviour you can now execute that old
code within a subshell that contains that older version of `{stringr}`. Start by
creating a folder to contain everything needed for your subshell:

```{r}
path_env_stringr <- file.path(".", "_env_stringr_1.4.1")
```

Then, it is advised to use
[`rix::rix_init()`](https://b-rodrigues.github.io/rix/reference/rix_init.html)
to generate an `.Rprofile` for that subshell, which sets a number of environment
variables. This way, when the R session in that subshell starts, we don't have
any interference between that subshell and the main R session, as the R packages
that must be available to the subshell are only taken from the Nix store. The
Nix store is where software installed by Nix is... stored, and we don't want R
to be confused and go look for R packages in the user's library, which could
happen without this specific `.Rprofile` file:

```{r}
rix_init(
  project_path = path_env_stringr,
  rprofile_action = "overwrite",
  message_type = "simple"
)
```

We now generate the `default.nix` file for that subshell:

```{r}
rix(
  r_ver = "latest",
  r_pkgs = "stringr@1.4.1",
  overwrite = TRUE,
  project_path = path_env_stringr
)
```

Notice how we use the latest version of R (we could have used any other), but
`{stringr}` on version 1.4.1. Finally, we use `with_nix()` to evaluate
`stringr::str_subset(c("", "a"), "")` inside that subshell:

```{r}
out_nix_stringr <- with_nix(
  expr = function() stringr::str_subset(c("", "a"), ""),
  program = "R",
  exec_mode = "non-blocking",
  project_path = path_env_stringr,
  message_type = "simple"
)
```

Finally, we can check if the result is really `"a"` or not:

```{r}
identical("a", out_nix_stringr)
```

```{r, include = F}
unlink(path_env_stringr, recursive = T)
```

`with_nix()` should work whether you installed your main R session using Nix, or
not, but we're not sure this is true for Windows (or rather, WSL2): we don't have
a Windows license to test this on Windows, so if you're on Windows and use WSL2
and want to test this, we would be very happy to hear from you!

If you're interested into using project-specific, and reproducible development
environments, give `{rix}` and Nix a try! Learn more about `{rix}` on its Github
repository [here](https://github.com/b-rodrigues/rix) or
[website](https://b-rodrigues.github.io/rix/). We wrote many vignettes that are
conveniently numbered, so don't hesitate to [get
started](https://b-rodrigues.github.io/rix/articles/a-getting-started.html)!

<p>Hope you enjoyed! If you found this blog post useful, you might want to follow
me on <a href="https://fosstodon.org/@brodriguesco">Mastodon</a> or <a href="https://www.twitter.com/brodriguesco">twitter</a> for blog post updates and
<a href="https://www.buymeacoffee.com/brodriguesco">buy me an espresso</a> or <a href="https://www.paypal.me/brodriguesco">paypal.me</a>, or buy my <a href="https://www.brodrigues.co/about/books/">ebooks</a>.
You can also watch my videos on <a href="https://www.youtube.com/c/BrunoRodrigues1988/">youtube</a>.
So much content for you to consoom!</p>
<style>.bmc-button img{width: 27px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{line-height: 36px !important;height:37px !important;text-decoration: none !important;display:inline-flex !important;color:#ffffff !important;background-color:#272b30 !important;border-radius: 3px !important;border: 1px solid transparent !important;padding: 1px 9px !important;font-size: 22px !important;letter-spacing:0.6px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Cookie', cursive !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#82518c !important;}</style>
<p><link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet"><a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/brodriguesco"><img src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg" alt="Buy me an Espresso"><span style="margin-left:5px">Buy me an Espresso</span></a></p>
